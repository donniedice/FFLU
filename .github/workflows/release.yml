name: Package and Release

on:
  push:
    tags:
      - 'v*'  # Triggers only on version tags like v1.0.0, v1.0.0-alpha, etc.

env:
  CF_API_KEY: ${{ secrets.CF_API_KEY }}
  WOWI_API_TOKEN: ${{ secrets.WOWI_API_TOKEN }}
  WAGO_API_TOKEN: ${{ secrets.WAGO_API_TOKEN }}
  GITHUB_OAUTH: ${{ secrets.GITHUB_TOKEN }}

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Clone Project
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git user
        run: |
          git config --global user.name "donniedice"
          git config --global user.email "donniedice@protonmail.com"

      - name: Set Release Type
        id: set_release_type
        run: |
          TAG_NAME=${{ github.ref }}
          if [[ "$TAG_NAME" == *"beta"* ]]; then
            echo "release_type=beta" >> $GITHUB_OUTPUT
          elif [[ "$TAG_NAME" == *"alpha"* ]]; then
            echo "release_type=alpha" >> $GITHUB_OUTPUT
          else
            echo "release_type=release" >> $GITHUB_OUTPUT
          fi

      - name: Extract Version from TOC
        id: extract_version
        run: |
          version=$(grep -oP '^## Version: \K(.*)' ./*.toc)
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Package and Release
        uses: BigWigsMods/packager@master
        with:
          release-type: ${{ steps.set_release_type.outputs.release_type }}

      - name: Extract Changelog
        id: extract_changelog
        run: |
          # Extract the current version's changelog from docs/CHANGES.md
          # We need to find the section between the current version header and the next version header or EOF
          VERSION="${{ steps.extract_version.outputs.version }}"
          
          # Read the changelog and extract the current version's content
          CHANGELOG=$(awk -v version="$VERSION" '
            BEGIN { found = 0; content = "" }
            /^## Version/ {
              if ($3 == version) {
                found = 1
                next
              } else if (found) {
                exit
              }
            }
            found && /^---/ { exit }
            found { content = content $0 "\n" }
            END { print content }
          ' docs/CHANGES.md)
          
          # Escape special characters for JSON
          CHANGELOG="${CHANGELOG//$'\n'/\\n}"
          CHANGELOG="${CHANGELOG//\"/\\\"}"
          
          # Save to output
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send Discord Notification
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "Discord webhook not configured, skipping notification"
            exit 0
          fi
          
          # Determine release type emoji and color
          RELEASE_TYPE="${{ steps.set_release_type.outputs.release_type }}"
          if [ "$RELEASE_TYPE" = "alpha" ]; then
            EMOJI="🔬"
            COLOR="16711680"  # Red
            TYPE_TEXT="Alpha"
          elif [ "$RELEASE_TYPE" = "beta" ]; then
            EMOJI="🧪"
            COLOR="16744448"  # Orange
            TYPE_TEXT="Beta"
          else
            EMOJI="🚀"
            COLOR="16768000"  # Yellow/Gold for FFLU
            TYPE_TEXT="Release"
          fi
          
          # Format the changelog for Discord
          CHANGELOG="${{ steps.extract_changelog.outputs.changelog }}"
          
          # Create the Discord embed
          DISCORD_PAYLOAD=$(cat <<EOF
          {
            "embeds": [{
              "title": "$EMOJI FFLU v${{ steps.extract_version.outputs.version }} $TYPE_TEXT",
              "description": "A new version of Final Fantasy Level-Up! has been released!",
              "color": $COLOR,
              "fields": [
                {
                  "name": "📝 Changelog",
                  "value": "$CHANGELOG"
                },
                {
                  "name": "📦 Download",
                  "value": "[CurseForge](https://www.curseforge.com/wow/addons/fflu) • [WoWInterface](https://www.wowinterface.com/downloads/info26252-FFLU.html) • [Wago](https://addons.wago.io/addons/fflu) • [GitHub](https://github.com/donniedice/FFLU/releases/tag/${{ github.ref_name }})"
                }
              ],
              "footer": {
                "text": "RGX Mods Collection",
                "icon_url": "https://raw.githubusercontent.com/donniedice/FFLU/main/images/icon.png"
              },
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)",
              "thumbnail": {
                "url": "https://raw.githubusercontent.com/donniedice/FFLU/main/images/logo.png"
              }
            }]
          }
          EOF
          )
          
          # Send to Discord
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$DISCORD_PAYLOAD" \
               "$DISCORD_WEBHOOK"